app-id: community.pathofbuilding.PathOfBuilding
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
build-options:
  append-path: /usr/lib/sdk/rust-stable/bin
command: rusty-path-of-building
finish-args:
  - --socket=fallback-x11
  - --socket=wayland
  - --share=ipc
  - --share=network
  - --device=dri
cleanup:
  - /include

modules:
  - name: luajit
    buildsystem: simple
    build-commands:
      - make PREFIX=/app install -j$FLATPAK_BUILDER_N_JOBS
    sources:
      - type: git
        url: https://github.com/LuaJIT/LuaJIT.git
        commit: 04dca7911ea255f37be799c18d74c305b921c1a6

  - name: rusty-path-of-building
    buildsystem: simple
    build-commands:
      - install -Dm0644 cargo/config .cargo/config.toml
      - cd lua/libs/lzip; make DESTDIR=/app LUA_CMOD=/lib/lua/5.1 LUA_IMPL=luajit install
      - cargo --offline fetch --manifest-path Cargo.toml --verbose
      - cargo --offline build --release
      - install -Dm755 target/release/rusty-path-of-building /app/bin/rusty-path-of-building
    sources:
      - type: git
        url: https://github.com/meehl/rusty-path-of-building.git
        commit: 3af5e3dccbc686632d75fcfd7f8805231f1ac1b9
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
          is-main-source: true
          version-scheme: semantic
      - cargo-sources.json

  - name: luarocks
    buildsystem: simple
    build-commands:
      - ./configure --prefix=/app --lua-version=5.1
      - make
      - make install
    sources:
      - type: archive
        url: https://luarocks.org/releases/luarocks-3.11.1.tar.gz
        sha256: c3fb3d960dffb2b2fe9de7e3cb004dc4d0b34bb3d342578af84f84325c669102

  - name: dkjson
    buildsystem: simple
    build-commands:
      - luarocks build dkjson-2.8-1.src.rock
    sources:
      - type: file
        url: https://luarocks.org/manifests/dhkolf/dkjson-2.8-1.src.rock
        sha256: 3d8de09cd43a60a005ac769ee1cedc515952c892d63cba9ac925ed02afc98091

  - name: lua-utf8
    buildsystem: simple
    build-commands:
      - luarocks build luautf8-0.1.6-1.src.rock
    sources:
      - type: file
        url: https://luarocks.org/manifests/xavier-wang/luautf8-0.1.6-1.src.rock
        sha256: 37901bc127c4afe9f611bba58af7b12eda6599fc270e1706e2f767807dfacd82

  - name: Lua-cURLv3
    buildsystem: simple
    build-commands:
      - make DESTDIR=/app LUA_CMOD=/lib/lua/5.1 LUA_IMPL=luajit -j$FLATPAK_BUILDER_N_JOBS install
    sources:
      - type: archive
        url: https://github.com/Lua-cURL/Lua-cURLv3/archive/refs/tags/v0.3.13.tar.gz
        sha256: aba40511a7cac4422c0238d1db42b2124ea5a727b0745f7f434f3dc119cbb2db

  - name: extrafiles
    buildsystem: simple
    build-commands:
      - install -Dm644 community.pathofbuilding.PathOfBuilding.png /app/share/icons/hicolor/256x256/apps/community.pathofbuilding.PathOfBuilding.png
      - install -Dm644 community.pathofbuilding.PathOfBuilding.Poe1.desktop /app/share/applications/community.pathofbuilding.PathOfBuilding.Poe1.desktop
      - install -Dm644 community.pathofbuilding.PathOfBuilding.Poe2.desktop /app/share/applications/community.pathofbuilding.PathOfBuilding.Poe2.desktop
      - install -Dm644 community.pathofbuilding.PathOfBuilding.metainfo.xml /app/share/metainfo/community.pathofbuilding.PathOfBuilding.metainfo.xml
    sources:
      - type: file
        path: community.pathofbuilding.PathOfBuilding.png
      - type: file
        path: community.pathofbuilding.PathOfBuilding.Poe1.desktop
      - type: file
        path: community.pathofbuilding.PathOfBuilding.Poe2.desktop
      - type: file
        path: community.pathofbuilding.PathOfBuilding.metainfo.xml
