app-id: community.pathofbuilding.PathOfBuilding
runtime: org.kde.Platform
runtime-version: '5.15-21.08'
sdk: org.kde.Sdk
command: pob.sh
finish-args:
  - --socket=x11
  - --socket=wayland
  - --share=ipc
  - --share=network
  - --device=dri
cleanup:
  - '/include'
modules:
  - name: luajit
    buildsystem: simple
    build-commands:
      - make PREFIX=${FLATPAK_DEST} install -j16
    sources:
      - type: archive
        url: http://luajit.org/download/LuaJIT-2.1.0-beta3.tar.gz
        sha256: 1ad2e34b111c802f9d0cdf019e986909123237a28c746b21295b63c9e785d9c3

  - name: Lua-cURLv3
    buildsystem: simple
    build-commands:
      - make DESTDIR=${FLATPAK_DEST} LUA_IMPL=luajit -j16
    post-install:
      - cp lcurl.so ${FLATPAK_DEST}/
    sources:
      - type: archive
        url: https://github.com/Lua-cURL/Lua-cURLv3/archive/refs/tags/v0.3.13.tar.gz
        sha256: aba40511a7cac4422c0238d1db42b2124ea5a727b0745f7f434f3dc119cbb2db

  - name: pobfrontend
    buildsystem: meson
    post-install:
      - cp -a pobfrontend ${FLATPAK_DEST}/bin
    sources:
      - type: git
        url: https://gitlab.com/bcareil/pobfrontend.git
        branch: luajit

  - name: PathOfBuildingCommunity
    buildsystem: simple
    build-commands:
      - unzip runtime-win32.zip lua/xml.lua lua/base64.lua lua/sha1.lua
      - mv lua/*.lua .
      - rm -rf lua runtime-win32.zip runtime/*.dll runtime/*.exe
      - cp -ar * /app/
    sources:
      - type: archive
        url: https://github.com/PathOfBuildingCommunity/PathOfBuilding/archive/refs/tags/v2.11.0.tar.gz
        sha256: 6a7a23f103f110d7a8ff84e20bd0439ba48748ae1e7e95c7b473420dda1eadfe
      - type: patch
        path: PathOfBuilding-force-disable-devmode.patch

  - name: extrafiles
    buildsystem: simple
    build-commands:
      - install -Dm755 pob.sh ${FLATPAK_DEST}/bin/pob.sh
      - install -Dm644 community.pathofbuilding.PathOfBuilding.png ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/community.pathofbuilding.PathOfBuilding.png
      - install -Dm644 community.pathofbuilding.PathOfBuilding.desktop ${FLATPAK_DEST}/share/applications/community.pathofbuilding.PathOfBuilding.desktop
      - install -Dm644 community.pathofbuilding.PathOfBuilding.metainfo.xml ${FLATPAK_DEST}/share/metainfo/community.pathofbuilding.PathOfBuilding.metainfo.xml
    sources:
      - type: file
        path: pob.sh
      - type: file
        path: community.pathofbuilding.PathOfBuilding.png
      - type: file
        path: community.pathofbuilding.PathOfBuilding.desktop
      - type: file
        path: community.pathofbuilding.PathOfBuilding.metainfo.xml
